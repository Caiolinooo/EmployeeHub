<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Publica√ß√£o de Not√≠cias</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; margin: 10px 0; }
        .status { font-weight: bold; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Publica√ß√£o de Not√≠cias</h1>
        
        <div class="test-section info">
            <h3>üìã Instru√ß√µes</h3>
            <p>Este diagn√≥stico ir√° testar todos os aspectos da funcionalidade de publica√ß√£o de not√≠cias:</p>
            <ul>
                <li>Verifica√ß√£o de autentica√ß√£o</li>
                <li>Teste de permiss√µes</li>
                <li>Teste das APIs de not√≠cias</li>
                <li>Verifica√ß√£o de tokens</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîê 1. Verifica√ß√£o de Autentica√ß√£o</h3>
            <div class="status" id="auth-status">Aguardando teste...</div>
            <button onclick="testAuthentication()">Testar Autentica√ß√£o</button>
            <div class="log" id="auth-log"></div>
        </div>

        <div class="test-section">
            <h3>üõ°Ô∏è 2. Verifica√ß√£o de Permiss√µes</h3>
            <div class="status" id="permissions-status">Aguardando teste...</div>
            <button onclick="testPermissions()">Testar Permiss√µes</button>
            <div class="log" id="permissions-log"></div>
        </div>

        <div class="test-section">
            <h3>üì∞ 3. Teste de Cria√ß√£o de Not√≠cia</h3>
            <div class="status" id="news-status">Aguardando teste...</div>
            <button onclick="testNewsCreation()">Testar Cria√ß√£o</button>
            <div class="log" id="news-log"></div>
        </div>

        <div class="test-section">
            <h3>üìù 4. Teste de Cria√ß√£o de Post</h3>
            <div class="status" id="post-status">Aguardando teste...</div>
            <button onclick="testPostCreation()">Testar Post</button>
            <div class="log" id="post-log"></div>
        </div>

        <div class="test-section">
            <h3>üîÑ 5. Teste Completo</h3>
            <button onclick="runAllTests()">Executar Todos os Testes</button>
            <div class="log" id="complete-log"></div>
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            element.textContent += logEntry;
            element.scrollTop = element.scrollHeight;
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function testAuthentication() {
            const logId = 'auth-log';
            const statusId = 'auth-status';
            
            document.getElementById(logId).textContent = '';
            setStatus(statusId, 'Testando autentica√ß√£o...', 'info');
            log(logId, 'Iniciando teste de autentica√ß√£o...');

            try {
                // Verificar tokens no localStorage
                const token = localStorage.getItem('abzToken') || localStorage.getItem('token');
                const refreshToken = localStorage.getItem('abzRefreshToken') || localStorage.getItem('refreshToken');
                
                log(logId, `Token encontrado: ${token ? 'Sim' : 'N√£o'}`);
                log(logId, `Refresh token encontrado: ${refreshToken ? 'Sim' : 'N√£o'}`);
                
                if (token) {
                    log(logId, `Comprimento do token: ${token.length}`);
                    
                    // Tentar decodificar o token
                    try {
                        const parts = token.split('.');
                        if (parts.length === 3) {
                            const payload = JSON.parse(atob(parts[1]));
                            log(logId, `Token payload: ${JSON.stringify(payload, null, 2)}`);
                            
                            const exp = payload.exp * 1000;
                            const now = Date.now();
                            const isExpired = exp < now;
                            
                            log(logId, `Token expira em: ${new Date(exp).toLocaleString()}`);
                            log(logId, `Token expirado: ${isExpired ? 'Sim' : 'N√£o'}`);
                        }
                    } catch (e) {
                        log(logId, `Erro ao decodificar token: ${e.message}`);
                    }
                }

                // Testar verifica√ß√£o de token
                if (token) {
                    log(logId, 'Testando verifica√ß√£o de token...');
                    
                    const response = await fetch('/api/auth/verify-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ token })
                    });

                    log(logId, `Status da verifica√ß√£o: ${response.status}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(logId, `Usu√°rio verificado: ${JSON.stringify(data.user, null, 2)}`);
                        setStatus(statusId, '‚úÖ Autentica√ß√£o OK', 'success');
                    } else {
                        const error = await response.json();
                        log(logId, `Erro na verifica√ß√£o: ${JSON.stringify(error)}`);
                        setStatus(statusId, '‚ùå Erro na verifica√ß√£o do token', 'error');
                    }
                } else {
                    setStatus(statusId, '‚ùå Token n√£o encontrado', 'error');
                }

            } catch (error) {
                log(logId, `Erro: ${error.message}`);
                setStatus(statusId, '‚ùå Erro no teste', 'error');
            }
        }

        async function testPermissions() {
            const logId = 'permissions-log';
            const statusId = 'permissions-status';
            
            document.getElementById(logId).textContent = '';
            setStatus(statusId, 'Testando permiss√µes...', 'info');
            log(logId, 'Iniciando teste de permiss√µes...');

            try {
                const token = localStorage.getItem('abzToken') || localStorage.getItem('token');
                
                if (!token) {
                    log(logId, 'Token n√£o encontrado - n√£o √© poss√≠vel testar permiss√µes');
                    setStatus(statusId, '‚ùå Token necess√°rio', 'error');
                    return;
                }

                // Testar acesso √†s APIs de not√≠cias
                const endpoints = [
                    { url: '/api/news', method: 'GET', name: 'Listar not√≠cias antigas' },
                    { url: '/api/news/posts', method: 'GET', name: 'Listar posts' },
                ];

                for (const endpoint of endpoints) {
                    log(logId, `Testando ${endpoint.name}...`);
                    
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    log(logId, `${endpoint.name}: Status ${response.status}`);
                    
                    if (!response.ok) {
                        const error = await response.json();
                        log(logId, `Erro: ${JSON.stringify(error)}`);
                    }
                }

                setStatus(statusId, '‚úÖ Permiss√µes testadas', 'success');

            } catch (error) {
                log(logId, `Erro: ${error.message}`);
                setStatus(statusId, '‚ùå Erro no teste', 'error');
            }
        }

        async function testNewsCreation() {
            const logId = 'news-log';
            const statusId = 'news-status';
            
            document.getElementById(logId).textContent = '';
            setStatus(statusId, 'Testando cria√ß√£o de not√≠cia...', 'info');
            log(logId, 'Iniciando teste de cria√ß√£o de not√≠cia...');

            try {
                const token = localStorage.getItem('abzToken') || localStorage.getItem('token');
                
                if (!token) {
                    log(logId, 'Token n√£o encontrado');
                    setStatus(statusId, '‚ùå Token necess√°rio', 'error');
                    return;
                }

                const newsData = {
                    title: 'Teste de Not√≠cia - ' + new Date().toLocaleString(),
                    description: 'Esta √© uma not√≠cia de teste criada pelo diagn√≥stico',
                    date: new Date().toISOString(),
                    category: 'Teste',
                    author: 'Sistema de Diagn√≥stico',
                    enabled: true,
                    featured: false
                };

                log(logId, `Dados da not√≠cia: ${JSON.stringify(newsData, null, 2)}`);

                const response = await fetch('/api/news', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newsData)
                });

                log(logId, `Status da cria√ß√£o: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(logId, `Not√≠cia criada: ${JSON.stringify(result, null, 2)}`);
                    setStatus(statusId, '‚úÖ Not√≠cia criada com sucesso', 'success');
                } else {
                    const error = await response.json();
                    log(logId, `Erro na cria√ß√£o: ${JSON.stringify(error)}`);
                    setStatus(statusId, `‚ùå Erro: ${error.error || 'Desconhecido'}`, 'error');
                }

            } catch (error) {
                log(logId, `Erro: ${error.message}`);
                setStatus(statusId, '‚ùå Erro no teste', 'error');
            }
        }

        async function testPostCreation() {
            const logId = 'post-log';
            const statusId = 'post-status';
            
            document.getElementById(logId).textContent = '';
            setStatus(statusId, 'Testando cria√ß√£o de post...', 'info');
            log(logId, 'Iniciando teste de cria√ß√£o de post...');

            try {
                const token = localStorage.getItem('abzToken') || localStorage.getItem('token');
                
                if (!token) {
                    log(logId, 'Token n√£o encontrado');
                    setStatus(statusId, '‚ùå Token necess√°rio', 'error');
                    return;
                }

                // Primeiro, obter o ID do usu√°rio do token
                let userId = null;
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        userId = payload.userId;
                    }
                } catch (e) {
                    log(logId, `Erro ao obter userId do token: ${e.message}`);
                }

                const postData = {
                    title: 'Teste de Post - ' + new Date().toLocaleString(),
                    content: 'Este √© um post de teste criado pelo diagn√≥stico',
                    excerpt: 'Post de teste',
                    author_id: userId,
                    status: 'draft'
                };

                log(logId, `Dados do post: ${JSON.stringify(postData, null, 2)}`);

                const response = await fetch('/api/news/posts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                log(logId, `Status da cria√ß√£o: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(logId, `Post criado: ${JSON.stringify(result, null, 2)}`);
                    setStatus(statusId, '‚úÖ Post criado com sucesso', 'success');
                } else {
                    const error = await response.json();
                    log(logId, `Erro na cria√ß√£o: ${JSON.stringify(error)}`);
                    setStatus(statusId, `‚ùå Erro: ${error.error || 'Desconhecido'}`, 'error');
                }

            } catch (error) {
                log(logId, `Erro: ${error.message}`);
                setStatus(statusId, '‚ùå Erro no teste', 'error');
            }
        }

        async function runAllTests() {
            const logId = 'complete-log';
            document.getElementById(logId).textContent = '';
            log(logId, 'üöÄ Iniciando bateria completa de testes...');
            
            await testAuthentication();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testPermissions();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testNewsCreation();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testPostCreation();
            
            log(logId, '‚úÖ Todos os testes conclu√≠dos!');
        }

        // Executar teste de autentica√ß√£o automaticamente ao carregar
        window.addEventListener('load', () => {
            setTimeout(testAuthentication, 1000);
        });
    </script>
</body>
</html>
